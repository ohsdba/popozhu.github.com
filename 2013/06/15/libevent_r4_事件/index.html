<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    

    <title>Libevent事件 | popozhu</title>

    

    <!-- css -->
    <link href="http://fonts.useso.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/style.css">

    </head>

    <body>
	<div class="container">
	    <div class="banner">
    <div>
        <span class="site-title"> <a href="/" id="logo">popozhu</a> </span>

        
    </div>

    <div class="banner-right">
        <span class="banner-item"> <a href="/archives"> Misc </a> </span>
        <span class="banner-item"> <a href="/about"> About </a> </span>
    </div>
</div>


	    <section id="main"><article class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
	<header class="article-header">
	    <div class="article-title">
		<div class="title">Libevent事件</div> 
		<small>
		    <time datetime="2013-06-15T12:20:51.000Z" itemprop="datePublished">June 15 2013</time>
		</small>
	    </div>
	</header>
    

    <div class="article-entry" itemprop="articleBody">
	
	    
	    
		<div class="article-toc"> Toc <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个事件"><span class="toc-text">创建一个事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事件标识"><span class="toc-text">事件标识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于事件持续等待"><span class="toc-text">关于事件持续等待</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建一个默认回调函数的事件"><span class="toc-text">创建一个默认回调函数的事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#interface"><span class="toc-text">Interface</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-text">Example</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#只有超时的事件"><span class="toc-text">只有超时的事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建信号事件"><span class="toc-text">创建信号事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-text">Example</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#没有使用堆来分配和创建事件"><span class="toc-text">没有使用堆来分配和创建事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#interface"><span class="toc-text">Interface</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-text">Example</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#inteface"><span class="toc-text">Inteface</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-text">EXample</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#让事件等待或取消等待"><span class="toc-text">让事件等待或取消等待</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事件的优先顺序"><span class="toc-text">事件的优先顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#example"><span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#检查事件状态"><span class="toc-text">检查事件状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#example"><span class="toc-text">Example</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取当前正在执行的事件"><span class="toc-text">获取当前正在执行的事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一次性事件"><span class="toc-text">一次性事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手工激活事件"><span class="toc-text">手工激活事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bad-example-making-an-infinite-loop-with-event_active"><span class="toc-text">Bad Example: making an infinite loop with event_active()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化超时时间"><span class="toc-text">优化超时时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#废弃的事件处理函数"><span class="toc-text">废弃的事件处理函数</span></a></li></ol> </div>
	    

	    <blockquote>
<p>&#x539F;&#x6587;&#xFF1A;<a href="http://www.wangafu.net/~nickm/libevent-book/Ref4_event.html" target="_blank" rel="external">R4: Working with events</a>  </p>
</blockquote>
<p>&#x4E8B;&#x4EF6;&#x662F;Libevent&#x7684;&#x57FA;&#x672C;&#x64CD;&#x4F5C;&#x5355;&#x5143;&#x3002;&#x6BCF;&#x4E2A;&#x4E8B;&#x4EF6;&#x4EE3;&#x8868;&#x4E00;&#x7EC4;&#x60C5;&#x51B5;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;  </p>
<ol>
<li>&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x53EF;&#x4EE5;&#x8BFB;&#x5199;</li>
<li>&#x8FB9;&#x7F18;&#x89E6;&#x53D1;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x53D8;&#x6210;&#x53EF;&#x4EE5;&#x8BFB;&#x5199;</li>
<li>&#x4E8B;&#x4EF6;&#x8D85;&#x65F6;</li>
<li>&#x4FE1;&#x53F7;&#x5230;&#x6765;</li>
<li>&#x7528;&#x6237;&#x89E6;&#x53D1;&#x7684;&#x4E8B;&#x4EF6;</li>
</ol>
<p>&#x4E8B;&#x4EF6;&#x6709;&#x76F8;&#x4F3C;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;&#x8C03;&#x7528;Libevent&#x7684;&#x51FD;&#x6570;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#x5E76;&#x628A;&#x8BE5;&#x4E8B;&#x4EF6;&#x5173;&#x8054;&#x5230;&#x4E00;&#x4E2A;event_base&#x4E0A;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x5C31;&#x662F;<strong>&#x521D;&#x59CB;&#x5316;</strong>&#x7684;&#x72B6;&#x6001;&#x3002;&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x70B9;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x8C03;&#x7528;<code>add</code>&#xFF0C;&#x8BA9;&#x5B83;&#x5728;base&#x4E2D;&#x53D8;&#x6210;<strong>&#x7B49;&#x5F85;</strong>&#x72B6;&#x6001;&#x3002;&#x5728;&#x4E8B;&#x4EF6;&#x7B49;&#x5F85;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x7B26;&#x5408;&#x89E6;&#x53D1;&#x4E8B;&#x4EF6;&#x7684;&#x6761;&#x4EF6;&#x6EE1;&#x8DB3;&#xFF0C;&#x4E8B;&#x4EF6;&#x5C31;&#x53D8;&#x6210;<strong>&#x6FC0;&#x6D3B;</strong>&#x72B6;&#x6001;&#xFF0C;&#x6BD4;&#x5982;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x6539;&#x53D8;&#x4E86;&#x72B6;&#x6001;&#xFF0C;&#x6216;&#x8005;&#x8D85;&#x65F6;&#x6761;&#x4EF6;&#x3002;&#x4E8B;&#x4EF6;&#x6FC0;&#x6D3B;&#x540E;&#xFF0C;&#x5B83;&#x7684;&#xFF08;&#x6216;&#x8005;&#x7528;&#x6237;&#x63D0;&#x4F9B;&#x7684;&#xFF09;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x3002;&#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x88AB;&#x8BBE;&#x7F6E;<strong>&#x6301;&#x7EED;&#x7B49;&#x5F85;</strong>&#xFF0C;&#x90A3;&#x5B83;&#x7EE7;&#x7EED;&#x4FDD;&#x6301;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#xFF0C;&#x5426;&#x5219;&#x5F53;&#x5B83;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x4E8B;&#x4EF6;&#x5C31;&#x505C;&#x6B62;&#x7B49;&#x5F85;&#x3002;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;<strong>&#x5220;&#x9664;</strong>&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x4E8B;&#x4EF6;&#x6765;&#x53D6;&#x6D88;&#x7B49;&#x5F85;&#x3002;</p>
<p><br></p>
<h2 id="&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;"><a href="#&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;"></a>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;</h2><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x4F7F;&#x7528;<code>event_new()</code>&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF1A;  </p>
<pre><code>#define EV_TIMEOUT      0x01
#define EV_READ         0x02
#define EV_WRITE        0x04
#define EV_SIGNAL       0x08
#define EV_PERSIST      0x10
#define EV_ET           0x20

typedef void (*event_callback_fn)(evutil_socket_t, short, void *);

struct event *event_new(struct event_base *base, evutil_socket_t fd,
    short what, event_callback_fn cb,
    void *arg);

void event_free(struct event *event);
</code></pre><p><code>event_new()</code>&#x51FD;&#x6570;&#x5C1D;&#x8BD5;&#x5206;&#x914D;&#x5185;&#x5B58;&#x548C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4E8B;&#x4EF6;&#x4EE5;&#x7ED9;base&#x4F7F;&#x7528;&#x3002;&#x53C2;&#x6570;<code>what</code>&#x5305;&#x542B;&#x4E0A;&#x9762;&#x5217;&#x51FA;&#x7684;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x6807;&#x8BC6;&#x3002;&#x5982;&#x679C;<code>fd</code>&#x4E3A;&#x975E;&#x8D1F;&#x6570;&#xFF0C;&#x90A3;&#x5B83;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#x76D1;&#x542C;&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x3002;&#x5F53;&#x4E8B;&#x4EF6;&#x6FC0;&#x6D3B;&#x540E;&#xFF0C;Libevent&#x5C06;&#x4F1A;&#x8C03;&#x7528;&#x56DE;&#x8C03;&#x51FD;&#x6570;<code>cb</code>&#xFF0C;&#x4F20;&#x7ED9;&#x8FD9;&#x4E2A;&#x56DE;&#x8C03;&#x51FD;&#x6570;3&#x4E2A;&#x53C2;&#x6570;&#xFF1A;a)&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;<code>fd</code>&#xFF0C;b)&#x89E6;&#x53D1;&#x7684;&#x4E8B;&#x4EF6;&#x6807;&#x8BC6;&#xFF0C;c)&#x539F;&#x672C;&#x4F20;&#x7ED9;<code>event_new()</code>&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x53C2;&#x6570;<code>arg</code>&#x3002;  </p>
<p>&#x5982;&#x679C;&#x51FA;&#x73B0;&#x5185;&#x90E8;&#x9519;&#x8BEF;&#xFF0C;&#x6216;&#x8005;&#x9047;&#x5230;&#x65E0;&#x6548;&#x7684;&#x53C2;&#x6570;&#xFF0C;<code>event_new()</code>&#x8FD4;&#x56DE;NULL&#x6307;&#x9488;&#x3002;  </p>
<p>&#x4E00;&#x4E2A;&#x65B0;&#x4E8B;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x4E4B;&#x540E;&#xFF0C;&#x8FD8;&#x662F;&#x975E;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;&#x8C03;&#x7528;<code>event_add()</code>&#x6765;&#x8BA9;&#x4E8B;&#x4EF6;&#x53D8;&#x6210;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#xFF08;&#x4E0B;&#x9762;&#x8BB2;&#x5230;&#xFF09;&#x3002;  </p>
<p>&#x8C03;&#x7528;<code>event_free()</code>&#x6765;&#x91CA;&#x653E;&#x4E8B;&#x4EF6;&#x3002;&#x91CA;&#x653E;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x6216;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#x7684;&#x4E8B;&#x4EF6;&#x662F;&#x5B89;&#x5168;&#x7684;&#xFF1A;&#x5B83;&#x4F1A;&#x5148;&#x8BA9;&#x4E8B;&#x4EF6;&#x505C;&#x6B62;&#x7B49;&#x5F85;&#xFF0C;&#x6216;&#x8005;&#x8BA9;&#x5B83;&#x53D8;&#x6210;&#x975E;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#xFF0C;&#x518D;&#x91CA;&#x653E;&#x5B83;&#x3002;  </p>
<h4 id="example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><pre><code>#include &lt;event2/event.h&gt;

void cb_func(evutil_socket_t fd, short what, void *arg)
{
        const char *data = arg;
        printf(&quot;Got an event on socket %d:%s%s%s%s [%s]&quot;,
            (int) fd,
            (what&amp;EV_TIMEOUT) ? &quot; timeout&quot; : &quot;&quot;,
            (what&amp;EV_READ)    ? &quot; read&quot; : &quot;&quot;,
            (what&amp;EV_WRITE)   ? &quot; write&quot; : &quot;&quot;,
            (what&amp;EV_SIGNAL)  ? &quot; signal&quot; : &quot;&quot;,
            data);
}

void main_loop(evutil_socket_t fd1, evutil_socket_t fd2)
{
        struct event *ev1, *ev2;
        struct timeval five_seconds = {5,0};
        struct event_base *base = event_base_new();

        /* The caller has already set up fd1, fd2 somehow, and make them
           nonblocking. */

        ev1 = event_new(base, fd1, EV_TIMEOUT|EV_READ|EV_PERSIST, cb_func,
           (char*)&quot;Reading event&quot;);
        ev2 = event_new(base, fd2, EV_WRITE|EV_PERSIST, cb_func,
           (char*)&quot;Writing event&quot;);

        event_add(ev1, &amp;five_seconds);
        event_add(ev2, NULL);
        event_base_dispatch(base);
}
</code></pre><h3 id="&#x4E8B;&#x4EF6;&#x6807;&#x8BC6;"><a href="#&#x4E8B;&#x4EF6;&#x6807;&#x8BC6;" class="headerlink" title="&#x4E8B;&#x4EF6;&#x6807;&#x8BC6;"></a>&#x4E8B;&#x4EF6;&#x6807;&#x8BC6;</h3><ol>
<li>EV_TIMEOUT<br> &#x8868;&#x793A;&#x5728;&#x4E00;&#x4E2A;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x4E4B;&#x540E;&#xFF0C;&#x4E8B;&#x4EF6;&#x4F1A;&#x53D8;&#x6210;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#x3002;<br> EV_TIMEOUT&#x6807;&#x8BC6;&#x5728;&#x4E8B;&#x4EF6;&#x521B;&#x5EFA;&#x65F6;&#x662F;&#x88AB;&#x5FFD;&#x7565;&#x7684;&#xFF1A;&#x4F60;&#x5728;&#x6DFB;&#x52A0;&#x4E8B;&#x4EF6;&#x65F6;&#x4E5F;&#x53EF;&#x4EE5;&#x4E0D;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E2A;&#x6807;&#x8BC6;&#x3002;&#x5F53;&#x8D85;&#x65F6;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x6267;&#x884C;&#x524D;&#xFF0C;&#x8FD9;&#x4E2A;&#x6807;&#x8BC6;&#x4F1A;&#x88AB;&#x8BBE;&#x7F6E;&#x5230;&#x53C2;&#x6570;<code>what</code>&#x4E2D;&#xFF0C;&#x518D;&#x4F20;&#x7ED9;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x3002;  </li>
<li>EV_READ<br> &#x5F53;&#x63D0;&#x4F9B;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x53EF;&#x8BFB;&#x65F6;&#x6FC0;&#x6D3B;&#x4E8B;&#x4EF6;&#x3002;  </li>
<li>EV_WRITE<br> &#x5F53;&#x63D0;&#x4F9B;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x53EF;&#x5199;&#x65F6;&#x6FC0;&#x6D3B;&#x4E8B;&#x4EF6;&#x3002;  </li>
<li>EV_SIGNAL<br> &#x7528;&#x6765;&#x68C0;&#x6D4B;&#x4FE1;&#x53F7;&#x3002;  </li>
<li>EV_PERSIST<br> &#x8868;&#x793A;&#x4E8B;&#x4EF6;&#x662F;&#x6301;&#x7EED;&#x7B49;&#x5F85;&#x7684;&#x3002;  </li>
<li>EV_ET<br> &#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x7684;&#x540E;&#x7AEF;&#x51FD;&#x6570;&#x652F;&#x6301;&#x8FB9;&#x7F18;&#x89E6;&#x53D1;&#x4E8B;&#x4EF6;&#xFF0C;&#x90A3;&#x5F53;&#x524D;&#x7684;&#x4E8B;&#x4EF6;&#x5E94;&#x8BE5;&#x662F;&#x8FB9;&#x7F18;&#x89E6;&#x53D1;&#x3002;&#x8FD9;&#x4E2A;&#x5F71;&#x54CD;&#x5230;EV_READ&#x548C;EV_WRITE&#x7684;&#x8BED;&#x610F;&#x3002;<br>&#x5728;Libevent 2.0.1-alpha&#x4E4B;&#x540E;&#xFF0C;&#x4EFB;&#x610F;&#x6570;&#x91CF;&#x7684;&#x4E8B;&#x4EF6;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x7B49;&#x5F85;&#x540C;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x7ED9;&#x51FA;&#x7684;<code>fd</code>&#x53D8;&#x6210;&#x53EF;&#x8BFB;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x6709;2&#x4E2A;&#x4E8B;&#x4EF6;&#x540C;&#x65F6;&#x88AB;&#x6FC0;&#x6D3B;&#xFF0C;&#x4F46;&#x54EA;&#x4E2A;&#x4E8B;&#x4EF6;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5148;&#x6267;&#x884C;&#x5219;&#x662F;&#x4E0D;&#x786E;&#x5B9A;&#x7684;&#x3002;  </li>
</ol>
<h3 id="&#x5173;&#x4E8E;&#x4E8B;&#x4EF6;&#x6301;&#x7EED;&#x7B49;&#x5F85;"><a href="#&#x5173;&#x4E8E;&#x4E8B;&#x4EF6;&#x6301;&#x7EED;&#x7B49;&#x5F85;" class="headerlink" title="&#x5173;&#x4E8E;&#x4E8B;&#x4EF6;&#x6301;&#x7EED;&#x7B49;&#x5F85;"></a>&#x5173;&#x4E8E;&#x4E8B;&#x4EF6;&#x6301;&#x7EED;&#x7B49;&#x5F85;</h3><p>&#x5F53;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x7684;&#x4E8B;&#x4EF6;&#x6FC0;&#x6D3B;&#xFF0C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x6267;&#x884C;&#x540E;&#xFF0C;&#x4E8B;&#x4EF6;&#x9ED8;&#x8BA4;&#x5C31;&#x4E0D;&#x518D;&#x7B49;&#x5F85;&#x4E86;&#x3002;&#x6240;&#x4EE5;&#x82E5;&#x4F60;&#x60F3;&#x8BA9;&#x4E8B;&#x4EF6;&#x91CD;&#x65B0;&#x7B49;&#x5F85;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x91CC;&#x8C03;&#x7528;<code>event_add()</code>&#x51FD;&#x6570;&#x3002;  </p>
<p>&#x4F46;&#x662F;&#xFF0C;&#x82E5;&#x4E8B;&#x4EF6;&#x8BBE;&#x7F6E;&#x4E86;<code>EV_PERSIST</code>&#x6807;&#x8BC6;&#xFF0C;&#x90A3;&#x5B83;&#x5C06;&#x4F1A;&#x7EE7;&#x7EED;&#x7B49;&#x5F85;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5F53;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x6267;&#x884C;&#x65F6;&#xFF0C;&#x4E8B;&#x4EF6;&#x4E5F;&#x5904;&#x4E8E;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x6682;&#x505C;&#x7B49;&#x5F85;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x91CC;&#x8C03;&#x7528;<code>event_del()</code>&#x51FD;&#x6570;&#x3002;  </p>
<p>&#x5F53;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x540E;&#xFF0C;&#x8BE5;&#x6301;&#x7EED;&#x7B49;&#x5F85;&#x7684;&#x4E8B;&#x4EF6;&#x4F1A;&#x91CD;&#x7F6E;&#x8D85;&#x65F6;&#x3002;&#x5982;&#x679C;&#x4F60;&#x6709;&#x4E00;&#x4E2A;&#x8BBE;&#x7F6E;<code>EV_READ|EV_PERSIST</code>&#x6807;&#x8BC6;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x4EE5;&#x53CA;&#x4E8B;&#x4EF6;&#x6709;&#x4E00;&#x4E2A;5&#x79D2;&#x7684;&#x8D85;&#x65F6;&#x6761;&#x4EF6;&#xFF0C;&#x90A3;&#x4E8B;&#x4EF6;&#x4F1A;&#x88AB;&#x6FC0;&#x6D3B;&#xFF0C;&#x5F53;&#xFF1A;  </p>
<ol>
<li>socket&#x53EF;&#x8BFB;&#x65F6;  </li>
<li>&#x4E0A;&#x6B21;&#x4E8B;&#x4EF6;&#x6FC0;&#x6D3B;&#x4E4B;&#x540E;&#x7684;5&#x79D2;&#x4E4B;&#x540E;&#xFF0C;&#x4E8B;&#x4EF6;&#x518D;&#x6B21;&#x88AB;&#x6FC0;&#x6D3B;  </li>
</ol>
<h3 id="&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7684;&#x4E8B;&#x4EF6;"><a href="#&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7684;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7684;&#x4E8B;&#x4EF6;"></a>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7684;&#x4E8B;&#x4EF6;</h3><p>&#x4F60;&#x53EF;&#x80FD;&#x7ECF;&#x5E38;&#x9700;&#x8981;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x5B83;&#x81EA;&#x8EAB;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x4F60;&#x4E0D;&#x80FD;&#x4F20;&#x4E00;&#x4E2A;event&#x7684;&#x6307;&#x9488;&#x7ED9;<code>event_new()</code>&#xFF0C;&#x56E0;&#x4E3A;&#x8BE5;&#x4E8B;&#x4EF6;&#x8FD8;&#x672A;&#x5B58;&#x5728;&#x3002;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>event_self_cbarg()</code>&#x3002;  </p>
<h4 id="interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h4><pre><code>void *event_self_cbarg();
</code></pre><p>&#x8BE5;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x795E;&#x5947;&#x7684;&#x6307;&#x9488;&#xFF0C;&#x5F53;&#x8BE5;&#x6307;&#x9488;&#x4F5C;&#x4E3A;<code>arg</code>&#x53C2;&#x6570;&#x4F20;&#x7ED9;<code>event_new()</code>&#x65F6;&#xFF0C;<code>event_new()</code>&#x5C06;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x56DE;&#x8C03;&#x5B83;&#x81EA;&#x8EAB;&#x7684;&#x4E8B;&#x4EF6;&#x3002;  </p>
<h4 id="example"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><pre><code>#include &lt;event2/event.h&gt;

static int n_calls = 0;

void cb_func(evutil_socket_t fd, short what, void *arg)
{
    struct event *me = arg;

    printf(&quot;cb_func called %d times so far.\n&quot;, ++n_calls);

    if (n_calls &gt; 100)
       event_del(me);
}

void run(struct event_base *base)
{
    struct timeval one_sec = { 1, 0 };
    struct event *ev;
    /* We&apos;re going to set up a repeating timer to get called called 100
       times. */
    ev = event_new(base, -1, EV_PERSIST, cb_func, event_self_cbarg());
    event_add(ev, &amp;one_sec);
    event_base_dispatch(base);
}
</code></pre><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E5F;&#x53EF;&#x4EE5;&#x8DDF;<code>event_new()</code>&#xFF0C;<code>evtimer_new()</code>&#xFF0C;<code>evsignal_new()</code>&#xFF0C;<code>event_assign()</code>&#xFF0C;<code>evtimer_assign()</code>&#xFF0C;<code>evsignal_assign()</code>&#x4F7F;&#x7528;&#x3002;  </p>
<h4 id="&#x53EA;&#x6709;&#x8D85;&#x65F6;&#x7684;&#x4E8B;&#x4EF6;"><a href="#&#x53EA;&#x6709;&#x8D85;&#x65F6;&#x7684;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x53EA;&#x6709;&#x8D85;&#x65F6;&#x7684;&#x4E8B;&#x4EF6;"></a>&#x53EA;&#x6709;&#x8D85;&#x65F6;&#x7684;&#x4E8B;&#x4EF6;</h4><p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#xFF0C;&#x6709;&#x4E00;&#x7EC4;&#x4EE5;<code>evtimer_</code>&#x4E3A;&#x524D;&#x7F00;&#x7684;&#x5B8F;&#x6765;&#x652F;&#x6301;&#x53EA;&#x505A;&#x8D85;&#x65F6;&#x7684;&#x4E8B;&#x4EF6;&#x3002;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x5B8F;&#x53EF;&#x8BA9;&#x4F60;&#x7684;&#x4EE3;&#x7801;&#x66F4;&#x6E05;&#x6670;&#x3002;  </p>
<pre><code>#define evtimer_new(base, callback, arg) \
    event_new((base), -1, 0, (callback), (arg))
#define evtimer_add(ev, tv) \
    event_add((ev),(tv))
#define evtimer_del(ev) \
    event_del(ev)
#define evtimer_pending(ev, tv_out) \
    event_pending((ev), EV_TIMEOUT, (tv_out))
</code></pre><h4 id="&#x521B;&#x5EFA;&#x4FE1;&#x53F7;&#x4E8B;&#x4EF6;"><a href="#&#x521B;&#x5EFA;&#x4FE1;&#x53F7;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x521B;&#x5EFA;&#x4FE1;&#x53F7;&#x4E8B;&#x4EF6;"></a>&#x521B;&#x5EFA;&#x4FE1;&#x53F7;&#x4E8B;&#x4EF6;</h4><p>Libevent&#x4E5F;&#x80FD;&#x68C0;&#x6D4B;POSIX-style&#x7684;&#x4FE1;&#x53F7;&#xFF0C;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x51FD;&#x6570;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#xFF1A;  </p>
<pre><code>#define evsignal_new(base, signum, callback, arg) \
    event_new(base, signum, EV_SIGNAL|EV_PERSIST, cb, arg)
</code></pre><p>&#x53C2;&#x6570;&#x8DDF;<code>event_new</code>&#x4E00;&#x6837;&#xFF0C; &#x9664;&#x4E86;&#x7B2C;2&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x8FD9;&#x91CC;&#x63D0;&#x4F9B;&#x7684;&#x662F;&#x4FE1;&#x53F7;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x3002;  </p>
<h4 id="example"><a href="#Example-2" class="headerlink" title="Example"></a>Example</h4><pre><code>struct event *hup_event;
struct event_base *base = event_base_new();

/* call sighup_function on a HUP signal */
hup_event = evsignal_new(base, SIGHUP, sighup_function, NULL);
</code></pre><p>&#x6CE8;&#x610F;&#xFF0C;&#x5F53;&#x4FE1;&#x53F7;&#x51FA;&#x73B0;&#x540E;&#xFF0C;&#x4FE1;&#x53F7;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x662F;&#x5728;&#x4E8B;&#x4EF6;&#x8F6E;&#x8BE2;&#x65F6;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5B89;&#x5168;&#x8C03;&#x7528;&#x4E00;&#x4E9B;&#x51FD;&#x6570;&#xFF0C;&#x90A3;&#x4E9B;&#x5728;POSIX&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x51FD;&#x6570;&#x91CC;&#x53EF;&#x80FD;&#x4E0D;&#x63A8;&#x8350;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x3002;  </p>
<p>&#x4E5F;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x7528;&#x4E8E;&#x4FE1;&#x53F7;&#x4E8B;&#x4EF6;&#x7684;&#x4E00;&#x4E9B;&#x5B8F;&#xFF1A;</p>
<pre><code>#define evsignal_add(ev, tv) \
    event_add((ev),(tv))
#define evsignal_del(ev) \
    event_del(ev)
#define evsignal_pending(ev, what, tv_out) \
    event_pending((ev), (what), (tv_out))
</code></pre><p>&#x5728;&#x5F53;&#x524D;&#x7248;&#x672C;&#x7684;Libevent&#x4E2D;&#xFF0C;&#x5BF9;&#x4E8E;&#x591A;&#x6570;&#x540E;&#x7AEF;&#x5B9E;&#x73B0;&#xFF0C;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;event_base&#x6765;&#x76D1;&#x542C;&#x4FE1;&#x53F7;&#x3002;&#x5982;&#x679C;&#x4F60;&#x540C;&#x65F6;&#x5F80;2&#x4E2A;event_base&#x4E2D;&#x6DFB;&#x52A0;&#x4FE1;&#x53F7;&#x4E8B;&#x4EF6;&#xFF0C;&#x5373;&#x4F7F;&#x662F;&#x4E0D;&#x540C;&#x4FE1;&#x53F7;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x5F53;&#x4FE1;&#x53F7;&#x5230;&#x6765;&#x65F6;&#xFF0C;&#x4E5F;&#x53EA;&#x6709;&#x4E00;&#x4E2A;event_base&#x4F1A;&#x6536;&#x5230;&#x4FE1;&#x53F7;&#x3002;<br>kqueue&#x8FD9;&#x4E2A;&#x540E;&#x7AEF;&#x5219;&#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x9650;&#x5236;&#xFF08;&#x82F9;&#x679C;&#x7684;&#x961F;&#x5217;&#x554A;&#xFF09;&#x3002;  </p>
<h4 id="&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x5806;&#x6765;&#x5206;&#x914D;&#x548C;&#x521B;&#x5EFA;&#x4E8B;&#x4EF6;"><a href="#&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x5806;&#x6765;&#x5206;&#x914D;&#x548C;&#x521B;&#x5EFA;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x5806;&#x6765;&#x5206;&#x914D;&#x548C;&#x521B;&#x5EFA;&#x4E8B;&#x4EF6;"></a>&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x5806;&#x6765;&#x5206;&#x914D;&#x548C;&#x521B;&#x5EFA;&#x4E8B;&#x4EF6;</h4><p>&#x4E3A;&#x4E86;&#x6027;&#x80FD;&#x548C;&#x5176;&#x4ED6;&#x539F;&#x56E0;&#xFF0C;&#x4E00;&#x4E9B;&#x4EBA;&#x559C;&#x6B22;&#x5728;&#x4E00;&#x4E2A;&#x5927;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x5206;&#x914D;&#x4E8B;&#x4EF6;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x8FD9;&#x6837;&#x4F7F;&#x7528;&#xFF0C;&#x4ED6;&#x4EEC;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#xFF1A;  </p>
<ol>
<li>&#x5185;&#x5B58;&#x5206;&#x914D;&#x5668;&#x5728;&#x5806;&#x4E0A;&#x5206;&#x914D;&#x5C0F;&#x5BF9;&#x8C61;&#x5185;&#x5B58;&#x7684;&#x5F00;&#x9500;  </li>
<li>&#x5BF9;event&#x6570;&#x636E;&#x7ED3;&#x6784;&#x6307;&#x9488;&#x8FDB;&#x884C;&#x89E3;&#x5F15;&#x7528;&#x6240;&#x9700;&#x7684;&#x65F6;&#x95F4;&#x5F00;&#x9500;  </li>
<li>&#x91CD;&#x65B0;&#x7F13;&#x5B58;event&#x6240;&#x9700;&#x65F6;&#x95F4;&#x5F00;&#x9500;  </li>
</ol>
<p>&#x8FD9;&#x6837;&#x4F7F;&#x7528;&#x4F1A;&#x5E26;&#x6765;&#x8DDF;&#x5176;&#x4ED6;Libevent&#x7248;&#x672C;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x517C;&#x5BB9;&#x95EE;&#x9898;&#xFF0C;&#x56E0;&#x4E3A;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E0D;&#x540C;&#x957F;&#x5EA6;&#x7684;event&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;  </p>
<p>&#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x975E;&#x5E38;&#x5C0F;&#x7684;&#x5F00;&#x9500;&#xFF0C;&#x4E00;&#x822C;&#x4E0D;&#x5F71;&#x54CD;&#x7A0B;&#x5E8F;&#x3002; &#x4F60;&#x5E94;&#x8BE5;&#x575A;&#x6301;&#x4F7F;&#x7528;<code>event_new()</code>&#xFF0C;&#x9664;&#x975E;&#x4F60;&#x5728;&#x5806;&#x4E0A;&#x5206;&#x914D;&#x4E8B;&#x4EF6;&#x800C;&#x9047;&#x5230;&#x975E;&#x5E38;&#x660E;&#x663E;&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898;&#x3002;&#x4F7F;&#x7528;<code>event_assign()</code>&#x4F1A;&#x5728;&#x672A;&#x6765;&#x7684;Libevent&#x7248;&#x672C;&#x9047;&#x5230;&#x96BE;&#x4EE5;&#x5B9A;&#x4F4D;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x6765;Libevent&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x6BD4;&#x4F60;&#x4F7F;&#x7528;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x66F4;&#x5927;&#x7684;&#x5927;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;  </p>
<h4 id="interface"><a href="#Interface-1" class="headerlink" title="Interface"></a>Interface</h4><pre><code>int event_assign(struct event *event, struct event_base *base,
    evutil_socket_t fd, short what,
    void (*callback)(evutil_socket_t, short, void *), void *arg);
</code></pre><p>&#x9664;&#x4E86;<code>event</code>&#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x5176;&#x4ED6;&#x53C2;&#x6570;&#x8DDF;<code>event_new()</code>&#x4E00;&#x6837;&#xFF0C;&#x53C2;&#x6570;<code>event</code>&#x5FC5;&#x987B;&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x672A;&#x521D;&#x59CB;&#x5316;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5982;&#x679C;&#x51FA;&#x73B0;&#x5185;&#x90E8;&#x9519;&#x8BEF;&#x6216;&#x8005;&#x9047;&#x5230;&#x9519;&#x8BEF;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;-1&#x3002;  </p>
<h4 id="example"><a href="#Example-3" class="headerlink" title="Example"></a>Example</h4><pre><code>#include &lt;event2/event.h&gt;
/* Watch out!  Including event_struct.h means that your code will not
 * be binary-compatible with future versions of Libevent. */
#include &lt;event2/event_struct.h&gt;
#include &lt;stdlib.h&gt;

struct event_pair {
         evutil_socket_t fd;
         struct event read_event;
         struct event write_event;
};
void readcb(evutil_socket_t, short, void *);
void writecb(evutil_socket_t, short, void *);
struct event_pair *event_pair_new(struct event_base *base, evutil_socket_t fd)
{
        struct event_pair *p = malloc(sizeof(struct event_pair));
        if (!p) return NULL;
        p-&gt;fd = fd;
        event_assign(&amp;p-&gt;read_event, base, fd, EV_READ|EV_PERSIST, readcb, p);
        event_assign(&amp;p-&gt;write_event, base, fd, EV_WRITE|EV_PERSIST, writecb, p);
        return p;
}
</code></pre><p>&#x4F60;&#x4E5F;&#x80FD;&#x4F7F;&#x7528;<code>event_assign()</code>&#x6765;&#x521D;&#x59CB;&#x5316;&#x6808;&#x4E0A;&#x5206;&#x914D;&#x7684;&#x6216;&#x9759;&#x6001;&#x5206;&#x914D;&#x7684;&#x4E8B;&#x4EF6;&#x3002;  </p>
<p><em>&#x8B66;&#x544A;</em><br>&#x4E0D;&#x8981;&#x5BF9;&#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x5728;event_base&#x91CC;&#x7684;&#x4E14;&#x5DF2;&#x7ECF;&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#x7684;&#x4E8B;&#x4EF6;&#x8C03;&#x7528;<code>event_assign()</code>&#x3002;&#x5426;&#x5219;&#x4F1A;&#x5E26;&#x6765;&#x53CA;&#x5176;&#x96BE;&#x4EE5;&#x5B9A;&#x4F4D;&#x7684;&#x9519;&#x8BEF;&#x3002;&#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x5DF2;&#x7ECF;&#x521D;&#x59CB;&#x5316;&#x6216;&#x6B63;&#x5904;&#x4E8E;&#x7B49;&#x5F85;&#xFF0C;&#x5728;&#x4F60;&#x8C03;&#x7528;<code>event_assing()</code>&#x4E4B;&#x524D;&#x5148;&#x8C03;&#x7528;<code>event_del()</code>&#x3002;  </p>
<p>&#x5BF9;&#x4E8E;<code>event_assign()</code>&#x4E5F;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x4FBF;&#x4F7F;&#x7528;&#x7684;&#x5B8F;&#xFF1A;  </p>
<pre><code>#define evtimer_assign(event, base, callback, arg) \
    event_assign(event, base, -1, 0, callback, arg)
#define evsignal_assign(event, base, signum, callback, arg) \
    event_assign(event, base, signum, EV_SIGNAL|EV_PERSIST, callback, arg)
</code></pre><p>&#x5982;&#x679C;&#x4F60;&#x9700;&#x8981;&#x4F7F;&#x7528;<code>event_assign()</code>&#x5E76;&#x4E14;&#x60F3;&#x8DDF;&#x672A;&#x6765;&#x7684;Libevent&#x7248;&#x672C;&#x4FDD;&#x6301;&#x4E8C;&#x8FDB;&#x5236;&#x517C;&#x5BB9;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x65F6;&#x8BA9;Libevent&#x544A;&#x8BC9;&#x4F60;&#x4E00;&#x4E2A;event&#x6570;&#x636E;&#x7ED3;&#x6784;&#x9700;&#x8981;&#x591A;&#x5C11;&#x7A7A;&#x95F4;&#xFF1A;   </p>
<h4 id="inteface"><a href="#Inteface" class="headerlink" title="Inteface"></a>Inteface</h4><pre><code>size_t event_get_struct_event_size(void);
</code></pre><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8FD4;&#x56DE;event&#x6570;&#x636E;&#x7ED3;&#x6784;&#x9700;&#x8981;&#x591A;&#x5C11;&#x5B57;&#x8282;&#x3002;&#x8DDF;&#x4E4B;&#x524D;&#x8BF4;&#x7684;&#xFF0C;&#x9664;&#x975E;&#x4F60;&#x77E5;&#x9053;&#x4F60;&#x7684;&#x7A0B;&#x5E8F;&#x5728;&#x5806;&#x4E0A;&#x5206;&#x914D;&#x5185;&#x5B58;&#x4F1A;&#x5E26;&#x6765;&#x975E;&#x5E38;&#x4E25;&#x91CD;&#x7684;&#x6027;&#x80FD;&#x95EE;&#x9898;&#xFF0C;&#x5426;&#x5219;&#x4E0D;&#x8981;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4F1A;&#x8BA9;&#x4F60;&#x7684;&#x4EE3;&#x7801;&#x96BE;&#x4EE5;&#x9605;&#x8BFB;&#x548C;&#x7F16;&#x5199;&#x3002;  </p>
<p>&#x6CE8;&#x610F;&#xFF0C;&#x672A;&#x6765;&#x7248;&#x672C;&#x91CC;&#x7684;<code>event_get_struct_event_size()</code>&#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x8282;&#x6570;&#x503C;&#x53EF;&#x80FD;&#x6BD4;<code>sizeof(struct event)</code>&#x8981;&#x5C11;&#xFF0C;&#x5982;&#x679C;&#x53D1;&#x751F;&#x4E86;&#xFF0C;&#x90A3;&#x610F;&#x5473;&#x7740;struct event&#x672B;&#x7AEF;&#x7684;&#x989D;&#x5916;&#x5B57;&#x8282;&#x53EA;&#x662F;&#x586B;&#x5145;&#xFF0C;&#x5728;Libevent&#x7248;&#x672C;&#x4E2D;&#x4F7F;&#x7528;&#x3002;  </p>
<p>&#x8FD9;&#x91CC;&#x4E5F;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x4F46;&#x4E0D;&#x662F;&#x4F9D;&#x8D56;&#x5934;&#x6587;&#x4EF6;event_struct.h&#x91CC;&#x5B9A;&#x4E49;&#x7684;event&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x800C;&#x662F;&#x4F7F;&#x7528;<code>event_get_struct_size()</code>&#x5728;&#x8FD0;&#x884C;&#x65F6;&#x51B3;&#x5B9A;event&#x7684;&#x957F;&#x5EA6;&#x3002;  </p>
<h4 id="example"><a href="#EXample" class="headerlink" title="EXample"></a>EXample</h4><pre><code>#include &lt;event2/event.h&gt;
#include &lt;stdlib.h&gt;

/* When we allocate an event_pair in memory, we&apos;ll actually allocate
 * more space at the end of the structure.  We define some macros
 * to make accessing those events less error-prone. */
struct event_pair {
         evutil_socket_t fd;
};

/* Macro: yield the struct event &apos;offset&apos; bytes from the start of &apos;p&apos; */
#define EVENT_AT_OFFSET(p, offset) \
            ((struct event*) ( ((char*)(p)) + (offset) ))
/* Macro: yield the read event of an event_pair */
#define READEV_PTR(pair) \
            EVENT_AT_OFFSET((pair), sizeof(struct event_pair))
/* Macro: yield the write event of an event_pair */
#define WRITEEV_PTR(pair) \
            EVENT_AT_OFFSET((pair), \
                sizeof(struct event_pair)+event_get_struct_event_size())

/* Macro: yield the actual size to allocate for an event_pair */
#define EVENT_PAIR_SIZE() \
            (sizeof(struct event_pair)+2*event_get_struct_event_size())

void readcb(evutil_socket_t, short, void *);
void writecb(evutil_socket_t, short, void *);
struct event_pair *event_pair_new(struct event_base *base, evutil_socket_t fd)
{
        struct event_pair *p = malloc(EVENT_PAIR_SIZE());
        if (!p) return NULL;
        p-&gt;fd = fd;
        event_assign(READEV_PTR(p), base, fd, EV_READ|EV_PERSIST, readcb, p);
        event_assign(WRITEEV_PTR(p), base, fd, EV_WRITE|EV_PERSIST, writecb, p);
        return p;
}
</code></pre><p><br></p>
<h2 id="&#x8BA9;&#x4E8B;&#x4EF6;&#x7B49;&#x5F85;&#x6216;&#x53D6;&#x6D88;&#x7B49;&#x5F85;"><a href="#&#x8BA9;&#x4E8B;&#x4EF6;&#x7B49;&#x5F85;&#x6216;&#x53D6;&#x6D88;&#x7B49;&#x5F85;" class="headerlink" title="&#x8BA9;&#x4E8B;&#x4EF6;&#x7B49;&#x5F85;&#x6216;&#x53D6;&#x6D88;&#x7B49;&#x5F85;"></a>&#x8BA9;&#x4E8B;&#x4EF6;&#x7B49;&#x5F85;&#x6216;&#x53D6;&#x6D88;&#x7B49;&#x5F85;</h2><p>&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#x4E4B;&#x540E;&#xFF0C;&#x4F60;&#x4F1A;&#x8C03;&#x7528;<code>event_add()</code>&#x8BA9;&#x4E8B;&#x4EF6;&#x5F00;&#x59CB;&#x7B49;&#x5F85;&#xFF1A;   </p>
<pre><code>int event_add(struct event *ev, const struct timeval *tv);
</code></pre><p>&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;&#x5982;&#x679C;&#x53C2;&#x6570;<code>tv</code>&#x4E3A;NULL&#xFF0C; &#x4E8B;&#x4EF6;&#x6CA1;&#x6709;&#x8D85;&#x65F6;&#x6761;&#x4EF6;&#xFF0C;&#x5426;&#x5219;&#xFF0C;<code>tv</code>&#x5C31;&#x662F;&#x8D85;&#x65F6;&#x7684;&#x79D2;&#x6570;&#x548C;&#x5FAE;&#x79D2;&#x3002;  </p>
<pre><code>int event_del(struct event *ev);
</code></pre><p>&#x5BF9;&#x4E00;&#x4E2A;&#x521D;&#x59CB;&#x5316;&#x7684;&#x4E8B;&#x4EF6;&#x8C03;&#x7528;<code>event_del</code>&#x8BA9;&#x4E8B;&#x4EF6;&#x505C;&#x6B62;&#x7B49;&#x5F85;&#xFF0C;&#x4E5F;&#x8BA9;&#x5B83;&#x53D8;&#x6210;&#x975E;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#x3002; &#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x4E0D;&#x662F;&#x5904;&#x4E8E;&#x7B49;&#x5F85;&#x6216;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#xFF0C;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6CA1;&#x6709;&#x6548;&#x679C;&#x3002;&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;<br>&#x6CE8;&#x610F;&#xFF1A;&#x5728;&#x4E8B;&#x4EF6;&#x88AB;&#x6FC0;&#x6D3B;&#x4E4B;&#x540E;&#xFF0C;&#x4E14;&#x5728;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x4E4B;&#x524D;&#xFF0C;&#x82E5;&#x5220;&#x9664;&#x4E86;&#x4E8B;&#x4EF6;&#xFF0C;&#x90A3;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x4E0D;&#x4F1A;&#x6267;&#x884C;&#x3002;  </p>
<pre><code>int event_remove_timer(struct event *ev);
</code></pre><p>&#x6700;&#x540E;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x4E8B;&#x4EF6;&#x7684;&#x8D85;&#x65F6;&#x6761;&#x4EF6;&#xFF0C;&#x800C;&#x4E0D;&#x9700;&#x8981;&#x5220;&#x9664;&#x5B83;&#x7684;IO&#x6216;&#x8005;&#x4FE1;&#x53F7;&#x6761;&#x4EF6;&#x3002;&#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x6CA1;&#x6709;&#x7B49;&#x5F85;&#x7684;&#x8D85;&#x65F6;&#x6761;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6CA1;&#x6709;&#x6548;&#x679C;&#x3002;&#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x53EA;&#x6709;&#x8D85;&#x65F6;&#x6761;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7B49;&#x540C;<code>event_del</code>&#x3002;&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;  </p>
<p><br></p>
<h2 id="&#x4E8B;&#x4EF6;&#x7684;&#x4F18;&#x5148;&#x987A;&#x5E8F;"><a href="#&#x4E8B;&#x4EF6;&#x7684;&#x4F18;&#x5148;&#x987A;&#x5E8F;" class="headerlink" title="&#x4E8B;&#x4EF6;&#x7684;&#x4F18;&#x5148;&#x987A;&#x5E8F;"></a>&#x4E8B;&#x4EF6;&#x7684;&#x4F18;&#x5148;&#x987A;&#x5E8F;</h2><p>&#x5F53;&#x591A;&#x4E2A;&#x4E8B;&#x4EF6;&#x540C;&#x65F6;&#x88AB;&#x89E6;&#x53D1;&#xFF0C;Libevent&#x5E76;&#x6CA1;&#x6709;&#x5B9A;&#x4E49;&#x4ED6;&#x4EEC;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x7684;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4ED6;&#x4EEC;&#x7684;&#x4F18;&#x5148;&#x987A;&#x5E8F;&#x6765;&#x8BA9;&#x4E00;&#x4E9B;&#x4E8B;&#x4EF6;&#x53D8;&#x5F97;&#x66F4;&#x4E3A;&#x91CD;&#x8981;&#x3002;  </p>
<p>&#x524D;&#x4E00;&#x7AE0;&#x91CC;&#x63D0;&#x5230;&#xFF0C;&#x6BCF;&#x4E2A;event_base&#x6709;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x4F18;&#x5148;&#x987A;&#x5E8F;&#x7684;&#x503C;&#x3002;&#x4E8B;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x4E4B;&#x540E;&#xFF0C;&#x5728;&#x6DFB;&#x52A0;&#x5230;event_base&#x4E4B;&#x524D;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x4E8B;&#x4EF6;&#x7684;&#x4F18;&#x5148;&#x987A;&#x5E8F;&#x3002;  </p>
<pre><code>int event_priority_set(struct event *event, int priority);
</code></pre><p>&#x7B2C;2&#x4E2A;&#x53C2;&#x6570;<code>priority</code>&#x7684;&#x503C;&#x6700;&#x5C0F;&#x4E3A;0&#xFF0C;&#x6700;&#x5927;&#x4E3A;event_base&#x7684;&#x4F18;&#x5148;&#x503C;-1&#xFF0C;&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;  </p>
<p>&#x5F53;&#x591A;&#x4E2A;&#x4E8B;&#x4EF6;&#x540C;&#x65F6;&#x6FC0;&#x6D3B;&#xFF0C;&#x4F4E;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x4E8B;&#x4EF6;&#x6CA1;&#x6709;&#x6267;&#x884C;&#xFF0C;Libevent&#x5148;&#x6267;&#x884C;&#x9AD8;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x68C0;&#x67E5;&#x4E8B;&#x4EF6;&#x3002; &#x53EA;&#x6709;&#x5F53;&#x6CA1;&#x6709;&#x9AD8;&#x7EA7;&#x522B;&#x7684;&#x4E8B;&#x4EF6;&#x6FC0;&#x6D3B;&#xFF0C;&#x4F4E;&#x7EA7;&#x522B;&#x7684;&#x4E8B;&#x4EF6;&#x624D;&#x88AB;&#x6267;&#x884C;&#x3002;  </p>
<h3 id="example"><a href="#Example-4" class="headerlink" title="Example"></a>Example</h3><pre><code>#include &lt;event2/event.h&gt;

void read_cb(evutil_socket_t, short, void *);
void write_cb(evutil_socket_t, short, void *);

void main_loop(evutil_socket_t fd)
{
  struct event *important, *unimportant;
  struct event_base *base;

  base = event_base_new();
  event_base_priority_init(base, 2);
  /* Now base has priority 0, and priority 1 */
  important = event_new(base, fd, EV_WRITE|EV_PERSIST, write_cb, NULL);
  unimportant = event_new(base, fd, EV_READ|EV_PERSIST, read_cb, NULL);
  event_priority_set(important, 0);
  event_priority_set(unimportant, 1);

  /* Now, whenever the fd is ready for writing, the write callback will
     happen before the read callback.  The read callback won&apos;t happen at
     all until the write callback is no longer active. */
}
</code></pre><p>&#x5982;&#x679C;&#x4F60;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x4E8B;&#x4EF6;&#x7684;&#x4F18;&#x5148;&#x7B49;&#x7EA7;&#xFF0C;&#x90A3;&#x4E8B;&#x4EF6;&#x7684;&#x9ED8;&#x8BA4;&#x4F18;&#x5148;&#x7B49;&#x7EA7;&#x4E3A;event_base&#x7684;&#x4E00;&#x534A;&#x3002;  </p>
<p><br></p>
<h2 id="&#x68C0;&#x67E5;&#x4E8B;&#x4EF6;&#x72B6;&#x6001;"><a href="#&#x68C0;&#x67E5;&#x4E8B;&#x4EF6;&#x72B6;&#x6001;" class="headerlink" title="&#x68C0;&#x67E5;&#x4E8B;&#x4EF6;&#x72B6;&#x6001;"></a>&#x68C0;&#x67E5;&#x4E8B;&#x4EF6;&#x72B6;&#x6001;</h2><p>&#x6709;&#x65F6;&#x5019;&#x4F60;&#x60F3;&#x68C0;&#x67E5;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;&#x6DFB;&#x52A0;&#x3002;  </p>
<pre><code>int event_pending(const struct event *ev, short what, struct timeval *tv_out);

#define event_get_signal(ev) /* ... */
evutil_socket_t event_get_fd(const struct event *ev);
struct event_base *event_get_base(const struct event *ev);
short event_get_events(const struct event *ev);
event_callback_fn event_get_callback(const struct event *ev);
void *event_get_callback_arg(const struct event *ev);
int event_get_priority(const struct event *ev);

void event_get_assignment(const struct event *event,
        struct event_base **base_out,
        evutil_socket_t *fd_out,
        short *events_out,
        event_callback_fn *callback_out,
        void **arg_out);
</code></pre><p>&#x51FD;&#x6570;<code>event_pending</code>&#x68C0;&#x6D4B;&#x7ED9;&#x51FA;&#x7684;&#x4E8B;&#x4EF6;&#x662F;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x8FD8;&#x662F;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#x3002;&#x5982;&#x679C;&#x662F;&#x8FD9;&#x4E24;&#x4E2A;&#x72B6;&#x6001;&#xFF0C;&#x800C;&#x4E14;<code>what</code>&#x8BBE;&#x7F6E;&#x4E86;<code>EV_READ, EV_WRITE, EV_SIGNAL, EV_TIMEOUT</code>&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x6807;&#x8BC6;&#xFF0C;&#x90A3;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x662F;&#x5426;&#x6709;&#x6807;&#x8BC6;&#x5BF9;&#x5E94;&#x7684;&#x7B49;&#x5F85;&#x6216;&#x6FC0;&#x6D3B;&#x7684;&#x4E8B;&#x4EF6;&#x7C7B;&#x578B;&#x3002;&#x5982;&#x679C;&#x63D0;&#x4F9B;&#x4E86;&#x53C2;&#x6570;<code>tv_out</code>&#xFF0C;&#x53C2;&#x6570;<code>what</code>&#x4E5F;&#x8BBE;&#x7F6E;&#x4E86;EV_TIMEOUT&#xFF0C;&#x5219;&#x5982;&#x679C;&#x4E8B;&#x4EF6;&#x5F53;&#x524D;&#x662F;&#x7B49;&#x5F85;&#x8D85;&#x65F6;&#x72B6;&#x6001;&#x6216;&#x8D85;&#x65F6;&#x540E;&#x88AB;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#xFF0C;&#x90A3;&#x8D85;&#x65F6;&#x7684;&#x65F6;&#x95F4;&#x70B9;&#x901A;&#x8FC7;<code>tv_out</code>&#x8FD4;&#x56DE;&#x3002;  </p>
<p>&#x51FD;&#x6570;<code>event_get_fd()</code>&#x548C;<code>event_get_signal()</code>&#x8FD4;&#x56DE;&#x4E8B;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x6216;&#x4FE1;&#x53F7;&#x53F7;&#x7801;&#x3002;<br>&#x51FD;&#x6570;<code>The event_get_base()</code>&#x8FD4;&#x56DE;event_base&#x3002;<br>&#x51FD;&#x6570;<code>event_get_events()</code>&#x8FD4;&#x56DE;&#x4E8B;&#x4EF6;&#x6807;&#x8BC6;&#xFF08;EV_READ, EV_WRITE&#x7B49;&#xFF09;&#x3002;<br>&#x51FD;&#x6570;<code>event_get_callback()</code>&#x548C;<code>event_get_callback_arg()</code>&#x8FD4;&#x56DE;&#x4E8B;&#x4EF6;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x548C;&#x53C2;&#x6570;&#x6307;&#x9488;&#x3002;<br>&#x51FD;&#x6570;<code>event_get_priority()</code>&#x8FD4;&#x56DE;&#x4E8B;&#x4EF6;&#x5F53;&#x524D;&#x7684;&#x4F18;&#x5148;&#x7B49;&#x7EA7;&#x3002;  </p>
<p>&#x51FD;&#x6570;<code>event_get_assignment()</code> &#x590D;&#x5236;&#x4E8B;&#x4EF6;&#x5206;&#x914D;&#x7684;&#x6240;&#x6709;&#x5B57;&#x6BB5;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x6307;&#x9488;&#x91CC;&#x3002;&#x5982;&#x679C;&#x6307;&#x9488;&#x4E3A;NULL&#xFF0C;&#x5219;&#x5FFD;&#x7565;&#x3002;  </p>
<h4 id="example"><a href="#Example-5" class="headerlink" title="Example"></a>Example</h4><pre><code>#include &lt;event2/event.h&gt;
#include &lt;stdio.h&gt;

/* Change the callback and callback_arg of &apos;ev&apos;, which must not be
 * pending. */
int replace_callback(struct event *ev, event_callback_fn new_callback,
    void *new_callback_arg)
{
    struct event_base *base;
    evutil_socket_t fd;
    short events;

    int pending;

    pending = event_pending(ev, EV_READ|EV_WRITE|EV_SIGNAL|EV_TIMEOUT,
                            NULL);
    if (pending) {
        /* We want to catch this here so that we do not re-assign a
         * pending event.  That would be very very bad. */
        fprintf(stderr,
                &quot;Error! replace_callback called on a pending event!\n&quot;);
        return -1;
    }

    event_get_assignment(ev, &amp;base, &amp;fd, &amp;events,
                         NULL /* ignore old callback */ ,
                         NULL /* ignore old callback argument */);

    event_assign(ev, base, fd, events, new_callback, new_callback_arg);
    return 0;
}
</code></pre><p><br></p>
<h2 id="&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;&#x4E8B;&#x4EF6;"><a href="#&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;&#x4E8B;&#x4EF6;"></a>&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;&#x4E8B;&#x4EF6;</h2><p>&#x4E3A;&#x4E86;&#x8C03;&#x8BD5;&#x6216;&#x5176;&#x4ED6;&#x539F;&#x56E0;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x6307;&#x9488;&#xFF0C;&#x6307;&#x5411;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x6267;&#x884C;&#x7684;&#x4E8B;&#x4EF6;&#x3002;  </p>
<pre><code>struct event *event_base_get_running_event(struct event_base *base);
</code></pre><p>&#x6CE8;&#x610F;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x63D0;&#x4F9B;&#x7684;event_base&#x7684;&#x5FAA;&#x73AF;&#x91CC;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x624D;&#x80FD;&#x8BA9;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x6B63;&#x786E;&#x6267;&#x884C;&#x3002; &#x4E0D;&#x652F;&#x6301;&#x5728;&#x53E6;&#x5916;&#x7EBF;&#x7A0B;&#x4E2D;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5C06;&#x5BFC;&#x81F4;&#x4E3A;&#x5B9A;&#x4E49;&#x7684;&#x884C;&#x4E3A;&#x3002;  </p>
<p><br></p>
<h2 id="&#x4E00;&#x6B21;&#x6027;&#x4E8B;&#x4EF6;"><a href="#&#x4E00;&#x6B21;&#x6027;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x4E00;&#x6B21;&#x6027;&#x4E8B;&#x4EF6;"></a>&#x4E00;&#x6B21;&#x6027;&#x4E8B;&#x4EF6;</h2><p>&#x5982;&#x679C;&#x4F60;&#x4E0D;&#x9700;&#x8981;&#x591A;&#x6B21;&#x6DFB;&#x52A0;&#x4E8B;&#x4EF6;&#xFF0C;&#x6216;&#x8005;&#x5728;&#x6DFB;&#x52A0;&#x4E4B;&#x540E;&#x4F1A;&#x9A6C;&#x4E0A;&#x5220;&#x9664;&#x5B83;&#xFF0C;&#x4E5F;&#x4E0D;&#x9700;&#x8981;&#x8BA9;&#x5B83;&#x6301;&#x7EED;&#x7B49;&#x5F85;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>event_base_once()</code>&#xFF1A;  </p>
<pre><code>int event_base_once(struct event_base *, evutil_socket_t, short,
  void (*)(evutil_socket_t, short, void *), void *, const struct timeval *);
</code></pre><p>&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x8DDF;<code>event_new()</code>&#x7C7B;&#x4F3C;&#xFF0C;&#x9664;&#x4E86;&#x5B83;&#x4E0D;&#x652F;&#x6301;&#x6807;&#x8BC6;<code>EV_SIGNAL</code>&#x548C;<code>EV_PERSIST</code>&#x3002;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#x4EE5;&#x9ED8;&#x8BA4;&#x7684;&#x4F18;&#x5148;&#x7B49;&#x7EA7;&#x5F00;&#x59CB;&#x6267;&#x884C;&#xFF0C;&#x5F53;&#x5B83;&#x7684;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;Libevent&#x91CA;&#x653E;&#x5B83;&#x5185;&#x90E8;&#x7684;event&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;  </p>
<p>&#x8FD9;&#x79CD;&#x4E00;&#x6B21;&#x6027;&#x4E8B;&#x4EF6;&#x4E0D;&#x80FD;&#x88AB;&#x5220;&#x9664;&#x6216;&#x624B;&#x5DE5;&#x6FC0;&#x6D3B;&#xFF1A;&#x5982;&#x679C;&#x4F60;&#x9700;&#x8981;&#x80FD;&#x591F;&#x53D6;&#x6D88;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;&#x4F60;&#x53EA;&#x80FD;&#x7528;&#x5E38;&#x89C4;&#x7684;&#x65B9;&#x5F0F;<code>event_new()</code>&#x6216;<code>event_assign()</code>.  </p>
<p><br></p>
<h2 id="&#x624B;&#x5DE5;&#x6FC0;&#x6D3B;&#x4E8B;&#x4EF6;"><a href="#&#x624B;&#x5DE5;&#x6FC0;&#x6D3B;&#x4E8B;&#x4EF6;" class="headerlink" title="&#x624B;&#x5DE5;&#x6FC0;&#x6D3B;&#x4E8B;&#x4EF6;"></a>&#x624B;&#x5DE5;&#x6FC0;&#x6D3B;&#x4E8B;&#x4EF6;</h2><p>&#x6BD4;&#x8F83;&#x5C11;&#x89C1;&#xFF0C;&#x4F46;&#x4F60;&#x53EF;&#x4EE5;&#x624B;&#x5DE5;&#x6FC0;&#x6D3B;&#x4E00;&#x4E2A;&#x8FD8;&#x672A;&#x88AB;&#x89E6;&#x53D1;&#x7684;&#x4E8B;&#x4EF6;&#x3002;  </p>
<pre><code>void event_active(struct event *ev, int what, short ncalls);
</code></pre><p>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8BA9;&#x4E8B;&#x4EF6;<code>ev</code>&#x6FC0;&#x6D3B;&#xFF0C;&#x8DDF;&#x968F;&#x6807;&#x8BC6;<code>what</code>&#x3002;&#x5728;&#x8C03;&#x7528;&#x4E4B;&#x524D;&#xFF0C;&#x4E8B;&#x4EF6;&#x4E0D;&#x9700;&#x8981;&#x5DF2;&#x7ECF;&#x5904;&#x4E8E;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#xFF0C;&#x6FC0;&#x6D3B;&#x4E4B;&#x540E;&#x4E5F;&#x4E0D;&#x4F1A;&#x8BA9;&#x5B83;&#x53D8;&#x6210;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;  </p>
<p>&#x8B66;&#x544A;&#xFF1A;&#x5BF9;&#x540C;&#x4E2A;&#x4E8B;&#x4EF6;&#x4E0D;&#x65AD;&#x91CD;&#x590D;&#x8C03;&#x7528;<code>event_active()</code>&#x53EF;&#x80FD;&#x56DE;&#x8017;&#x5C3D;&#x8D44;&#x6E90;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x4F7F;&#x7528;&#x7684;&#x4F8B;&#x5B50;&#x3002;  </p>
<h4 id="bad-example-making-an-infinite-loop-with-event_active"><a href="#Bad-Example-making-an-infinite-loop-with-event-active" class="headerlink" title="Bad Example: making an infinite loop with event_active()"></a>Bad Example: making an infinite loop with event_active()</h4><pre><code>struct event *ev;

static void cb(int sock, short which, void *arg) {
        /* Whoops: Calling event_active on the same event unconditionally
           from within its callback means that no other events might not get
           run! */

        event_active(ev, EV_WRITE, 0);
}

int main(int argc, char **argv) {
        struct event_base *base = event_base_new();

        ev = event_new(base, -1, EV_PERSIST | EV_READ, cb, NULL);

        event_add(ev, NULL);

        event_active(ev, EV_WRITE, 0);

        event_base_loop(base, 0);

        return 0;
}
</code></pre><p>&#x4F8B;&#x5B50;&#x4E2D;&#x53EA;&#x6709;&#x4E00;&#x6B21;&#x4E8B;&#x4EF6;&#x8F6E;&#x8BE2;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#x8C03;&#x7528;<code>cb</code>&#x3002;  </p>
<p><br></p>
<h2 id="&#x4F18;&#x5316;&#x8D85;&#x65F6;&#x65F6;&#x95F4;"><a href="#&#x4F18;&#x5316;&#x8D85;&#x65F6;&#x65F6;&#x95F4;" class="headerlink" title="&#x4F18;&#x5316;&#x8D85;&#x65F6;&#x65F6;&#x95F4;"></a>&#x4F18;&#x5316;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</h2><p>&#x7565;&#x3002;&#x5927;&#x610F;&#x662F;&#x5F53;&#x4F60;&#x9700;&#x8981;&#x540C;&#x65F6;&#x8BBE;&#x7F6E;&#x6570;&#x4EE5;&#x5343;&#x4E07;&#x4E2A;&#x8D85;&#x65F6;&#x4E8B;&#x4EF6;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5; &#x8BA9;Libevent&#x7ED9;&#x4F60;&#x4E00;&#x4E2A;&#x4F18;&#x5316;&#x540E;&#x7684;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#x503C;&#xFF0C;&#x4EE5;&#x4F18;&#x5316;&#x6027;&#x80FD;&#x3002;  </p>
<p><br></p>
<h2 id="&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x51FD;&#x6570;"><a href="#&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x51FD;&#x6570;" class="headerlink" title="&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x51FD;&#x6570;"></a>&#x5E9F;&#x5F03;&#x7684;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x51FD;&#x6570;</h2><p>&#x7565;&#x3002;</p>
<p><br><br>&#x2013; EOF &#x2013;</p>

	

	<div>
	    <div>Categories: <a class="category-link" href="/categories/in-lib/">in_lib</a> </div>
	    <div>Tags: <a class="tag-link" href="/tags/libevent/">libevent</a> </div>
	</div>
    </div>

    <hr />
    <footer class="article-footer">
      
        <a href="http://popozhu.github.io/2013/06/15/libevent_r4_事件/#disqus_thread" class="article-comment-link"></a>
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2013/06/19/安装smokeping/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-caption">&laquo;</span>
      <span class="article-nav-title">
        
          在os x上安装smokeping
        
      </span>
    </a>
  
  
    <a href="/2013/06/15/hexo代码高亮/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">hexo的代码高亮</span>
      <span class="article-nav-caption">&raquo;</span>
    </a>
  
</nav>


  
</article>


<section id="comments">
  <div id="disqus_thread"> </div>
</section>


</section>

	    <footer id="footer">
    popozhu &copy; 2016 
</footer>

	</div>

	
<!--
<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
-->


<script>
  var disqus_shortname = 'popozhu';
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


<script src="/js/script.js"></script>


    </body>
</html>
