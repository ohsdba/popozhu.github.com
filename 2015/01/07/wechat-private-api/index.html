<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    

    <title>wechat private api | popozhu</title>

    

    <link href="http://fonts.useso.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    </head>

    <body>
	<div class="container">
	    <div class="banner">
    <span class="site-title"> <a href="/" id="logo">popozhu</a> </span>

    
    <span class="site-subtitle"> do not go gentle into that good night </span>
    
</div>


	    <section id="main"><article class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
	<header class="article-header">
	    <div class="article-title">
		<div class="title">wechat private api</div> 
		<small>
		    <time datetime="2015-01-07T07:35:24.000Z" itemprop="datePublished">January 7th 2015</time>
		</small>
	    </div>
	</header>
    

    <div class="article-entry" itemprop="articleBody">
	
	    
	    

	    <p>模拟微信公众平台进行登录、回复上行消息的方式，来给我自己发送一些推送。</p>
<p>最近微信后台做了调整，登录太频繁的话，会被限制登录微信公众平台一个小时，接口连接时则收到 <code>access deny</code> 的报错信息。</p>
<p>到虚拟机的 windows 下，使用 Fiddler 抓了下 http 请求，检查以下几个方面是否有变化：</p>
<ol>
<li>get、post 的方式</li>
<li>提交的参数</li>
<li>设置的 referer</li>
<li>保存的 cookie</li>
</ol>
<p>过了一遍我所使用的接口（来自网络），原来没有重复使用缓存的 cookie， 每次都是重新登录。 源作者登录的频率较少，而我每3秒登录一次，就滥用了； 另外接口里登录和发送消息设置了一样的 referer， 暂时发现这两个问题。</p>
<p>修改：</p>
<ol>
<li>先修正接口里登录的 referer</li>
<li>减少登录的频率，改为5分钟登录一次，且校验登录是否成功（接口未做检查），再发送消息。</li>
</ol>
<p>依然继续这种粗糙的使用方式。</p>
<p>若是并发多，还是得重复使用缓存 cookie，方式有两种：</p>
<ol>
<li>每次发送前检查 cookie 有效性，模拟微信公众平台上任意的一次请求，检查返回结果，若请求失败或收到错误信息，则重新登录、获取并缓存 cookie</li>
<li>不检查 cookie 有效性，定时重新请求 cookie</li>
</ol>
<p>另外，若一次发送的消息内容过长会报错 <code>invalid args</code>， 对比正常的下行消息，估算下消息长度限制在 512 字节比较合适。</p>
<p>大概就这些，出于兴趣做的了解，非商业用途。</p>
<p><br><br>– EOF –</p>

	

	<div>
	    <div>Categories: <a class="category-link" href="/categories/in-notes/">in_notes</a> </div>
	    <div>Tags:<a class="tag-link" href="/tags/api/">api</a>,<a class="tag-link" href="/tags/wechat/">wechat</a> </div>
	</div>
    </div>

    <hr />
    <footer class="article-footer">
      
        <a href="http://popozhu.github.io/2015/01/07/wechat-private-api/#disqus_thread" class="article-comment-link"></a>
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/02/10/2015年云南之行/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-caption">&laquo;</span>
      <span class="article-nav-title">
        
          2015年云南之行-行程
        
      </span>
    </a>
  
  
    <a href="/2014/12/27/ios消息推送的优化/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">ios消息推送的优化</span>
      <span class="article-nav-caption">&raquo;</span>
    </a>
  
</nav>


  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>


</section>

	    <footer id="footer">
    <span> <a href="/about"> About </a> </span>
    <span> <a href="/archives"> Misc </a> </span>

    <span>
	<a href="http://hexo.io/" title="Hexo">Hexo</a>
    </span>
    <span>
	&copy; popozhu 2015 
    </span>
</footer>

	</div>

	
<!--
<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
-->


<script>
  var disqus_shortname = 'popozhu';
  
  var disqus_url = 'http://popozhu.github.io/2015/01/07/wechat-private-api/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/script.js" type="text/javascript"></script>

    </body>
</html>
