<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    

    <title>pnp4nagios的并发 | popozhu</title>

    

    <link href="http://fonts.useso.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    </head>

    <body>
	<div class="container">
	    <div class="banner">
    <div>
        <span class="site-title"> <a href="/" id="logo">popozhu</a> </span>

        
    </div>

    <div class="banner-right">
        <span class="banner-item"> <a href="/archives"> Misc </a> </span>
        <span class="banner-item"> <a href="/about"> About </a> </span>
    </div>
</div>


	    <section id="main"><article class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
	<header class="article-header">
	    <div class="article-title">
		<div class="title">pnp4nagios的并发</div> 
		<small>
		    <time datetime="2014-03-12T14:38:51.000Z" itemprop="datePublished">March 12 2014</time>
		</small>
	    </div>
	</header>
    

    <div class="article-entry" itemprop="articleBody">
	
	    
	    

	    <p>在前几天我写了个「<a href="/2014/03/09/pnp4nagios的模板/">pnp4nagios的模板</a>」后，发现使用npcd的bulk模式处理3.5w条性能数据，花费了将近30分钟时间，而我期望的是在1分钟内处理完。需要换个方式，为此我切换到<code>gearman模式</code>来并发，记录如下：</p>
<ol>
<li>换用SSD硬盘</li>
<li>对3.5w条源数据做多一步处理，合并相同host相同servicedesc的数据，最后只有3.4k条</li>
<li>停了npcd，启用gearmand做server端</li>
<li>以4个工作进程启动process_perfdata.pl，为4个worker</li>
<li>把3.4k条数据做为client数据，发送到server端</li>
</ol>
<p><br></p>
<p>###SSD硬盘<br>硬盘空间不是很充足，我减少了RRD文件大小。之前我把pnp4nagios安装到了/home目录下，则修改<code>/home/pnp4nagios/etc/rra.cfg</code>配置，让RRD文件只保存最多90天的数据<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">RRA_STEP=<span class="number">60</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># PNP default RRA config</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># you will get <span class="number">400</span>kb of data per datasource</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># <span class="number">2880</span> entries with <span class="number">1</span> minute step = <span class="number">48</span> hours</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">RRA:AVERAGE:<span class="number">0.5</span>:<span class="number">1</span>:<span class="number">2880</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># <span class="number">2880</span> entries with <span class="number">5</span> minute step = <span class="number">10</span> days</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">RRA:AVERAGE:<span class="number">0.5</span>:<span class="number">5</span>:<span class="number">2880</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># <span class="number">4320</span> entries with <span class="number">30</span> minute step = <span class="number">90</span> days</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">RRA:AVERAGE:<span class="number">0.5</span>:<span class="number">30</span>:<span class="number">4320</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># <span class="number">5840</span> entries with <span class="number">360</span> minute step = <span class="number">4</span> years</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor">#RRA:AVERAGE:<span class="number">0.5</span>:<span class="number">360</span>:<span class="number">5840</span></span></span><br><span class="line"></span><br><span class="line">RRA:MAX:<span class="number">0.5</span>:<span class="number">1</span>:<span class="number">2880</span></span><br><span class="line">RRA:MAX:<span class="number">0.5</span>:<span class="number">5</span>:<span class="number">2880</span></span><br><span class="line">RRA:MAX:<span class="number">0.5</span>:<span class="number">30</span>:<span class="number">4320</span></span><br><span class="line"><span class="preprocessor">#RRA:MAX:<span class="number">0.5</span>:<span class="number">360</span>:<span class="number">5840</span></span></span><br><span class="line"></span><br><span class="line">RRA:MIN:<span class="number">0.5</span>:<span class="number">1</span>:<span class="number">2880</span></span><br><span class="line">RRA:MIN:<span class="number">0.5</span>:<span class="number">5</span>:<span class="number">2880</span></span><br><span class="line">RRA:MIN:<span class="number">0.5</span>:<span class="number">30</span>:<span class="number">4320</span></span><br><span class="line"><span class="preprocessor">#RRA:MIN:<span class="number">0.5</span>:<span class="number">360</span>:<span class="number">5840</span></span></span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>###合并数据<br>无论是npcd来调用process_perfdata.pl，或者是在gearman中启动process_perfdata.pl的worker，实际写RRD文件的，都是这个<code>process_perfdata.pl</code>脚本，减少它对源数据的解析，自然是一个优化的点。举个例子</p>
<ol>
<li>DATATYPE::SERVICEPERFDATA   TIMET::1378779841   HOSTNAME::zh_v542   SERVICEDESC::PING   SERVICECHECKCOMMAND::check_icmp    SERVICEPERFDATA::rta=92.412ms;200.000;500.000;0; </li>
<li>DATATYPE::SERVICEPERFDATA   TIMET::1378779841   HOSTNAME::zh_v542   SERVICEDESC::PING   SERVICECHECKCOMMAND::check_icmp    SERVICEPERFDATA::pl=0%;40;80;; </li>
<li>DATATYPE::SERVICEPERFDATA   TIMET::1378779841   HOSTNAME::zh_v542   SERVICEDESC::PING   SERVICECHECKCOMMAND::check_icmp     SERVICEPERFDATA::rtmax=97.281ms;;;; </li>
<li>DATATYPE::SERVICEPERFDATA   TIMET::1378779841   HOSTNAME::zh_v542   SERVICEDESC::PING   SERVICECHECKCOMMAND::check_icmp    SERVICEPERFDATA::rtmin=86.727ms;;;;</li>
</ol>
<p>上面这4条数据，通过放弃时间戳TIMET(可能不同)，他们有相同的HOSTNAME和SERVICEDESC，合并为1条</p>
<ol>
<li>DATATYPE::SERVICEPERFDATA   TIMET::1378779841   HOSTNAME::zh_v542   SERVICEDESC::PING   SERVICECHECKCOMMAND::check_icmp    SERVICEPERFDATA::rta=92.412ms;200.000;500.000;0; pl=0%;40;80;; rtmax=97.281ms;;;; rtmin=86.727ms;;;;</li>
</ol>
<p><br></p>
<p>###server端<br>停了npcd： <code>/etc/init.d/npcd stop</code>  </p>
<p>修改gearmand的配置，主要添加<code>-t 4</code>，启动4个IO线程<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/sysconfig/gearmand</span><br><span class="line"><span class="preprocessor">### Settings for gearmand</span></span><br><span class="line"><span class="preprocessor"># OPTIONS=""</span></span><br><span class="line">OPTIONS=<span class="string">"--listen=127.0.0.1 --port=4730 --log-file=/diskb/pnp4nagios/gearmand/gearmand.log -t 4"</span></span><br></pre></td></tr></table></figure></p>
<p>以默认端口4730启动<code>/etc/init.d/gearmand start</code>，监听client发送上来的数据<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -an | grep <span class="number">4730</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">4730</span>              <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*                   LISTEN</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>###worker进程<br>在pnp4nagios的安装目录中，找到<code>/home/pnp4nagios/libexec/process_perfdata.pl</code>，修改worker工作方式，让其一直执行任务，而不需要重启，修改<code>new_child</code>这个函数(下面的第41行)<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># start a new worker process</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="sub"><span class="keyword">sub</span> new_child &#123;</span></span><br><span class="line">    <span class="keyword">my</span> <span class="variable">$pid</span>;</span><br><span class="line">    <span class="keyword">my</span> <span class="variable">$sigset</span>;</span><br><span class="line">    <span class="keyword">my</span> <span class="variable">$req</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment"># block signal for fork</span></span><br><span class="line">    <span class="variable">$sigset</span> = POSIX::SigSet-&gt;new(SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, <span class="variable">$sigset</span>)</span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't block SIGINT for fork: <span class="variable">$!</span>\n"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">die</span> <span class="string">"fork: <span class="variable">$!</span>"</span> <span class="keyword">unless</span> <span class="keyword">defined</span> (<span class="variable">$pid</span> = <span class="keyword">fork</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pid</span>) &#123;</span><br><span class="line">        <span class="comment"># Parent records the child's birth and returns.</span></span><br><span class="line">        sigprocmask(SIG_UNBLOCK, <span class="variable">$sigset</span>)</span><br><span class="line">            <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't unblock SIGINT for fork: <span class="variable">$!</span>\n"</span>;</span><br><span class="line">        <span class="variable">$children</span>&#123;<span class="variable">$pid</span>&#125; = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$children</span>++;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment"># Child can *not* return from this subroutine.</span></span><br><span class="line">        <span class="variable">$SIG</span><span class="string">&#123;INT&#125;</span> = <span class="string">'DEFAULT'</span>;      <span class="comment"># make SIGINT kill us as it did before</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment"># unblock signals</span></span><br><span class="line">        sigprocmask(SIG_UNBLOCK, <span class="variable">$sigset</span>)</span><br><span class="line">            <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't unblock SIGINT for fork: <span class="variable">$!</span>\n"</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">my</span> <span class="variable">$worker</span> = Gearman::Worker-&gt;new();</span><br><span class="line">        <span class="keyword">my</span> <span class="variable">@job_servers</span> = <span class="keyword">split</span>(<span class="regexp">/,/</span>, <span class="variable">$conf</span>&#123;<span class="string">'GEARMAN_HOST'</span>&#125;); <span class="comment"># allow multiple gearman job servers </span></span><br><span class="line">        <span class="variable">$worker</span>-&gt;job_servers(<span class="variable">@job_servers</span>);</span><br><span class="line">        <span class="comment"># worker向server注册的函数名为 perfdata，它对应的处理流程是 main函数</span></span><br><span class="line">        <span class="variable">$worker</span>-&gt;register_function(<span class="string">"perfdata"</span>, <span class="number">2</span>, <span class="sub"><span class="keyword">sub</span> &#123;</span> <span class="keyword">return</span> main(<span class="variable">@_</span>); &#125;);</span><br><span class="line">        <span class="keyword">my</span> <span class="variable">%opt</span> = ( </span><br><span class="line">                    <span class="string">on_complete =&gt;</span> <span class="sub"><span class="keyword">sub</span> &#123;</span> <span class="variable">$req</span>++; &#125;, </span><br><span class="line">                    <span class="string">stop_if =&gt;</span> <span class="sub"><span class="keyword">sub</span> &#123;</span> <span class="keyword">if</span> ( <span class="variable">$req</span> &gt; <span class="variable">$conf</span>&#123;<span class="string">'REQUESTS_PER_CHILD'</span>&#125; ) &#123; <span class="keyword">return</span> <span class="number">1</span>;&#125;; &#125; </span><br><span class="line">                  );</span><br><span class="line">        print_log(<span class="string">"connecting to gearmand '"</span>.<span class="variable">$conf</span>&#123;<span class="string">'GEARMAN_HOST'</span>&#125;.<span class="string">"'"</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 忽略REQUESTS_PER_CHILD配置项，不退出一直执行</span></span><br><span class="line">        <span class="variable">$worker</span>-&gt;work( <span class="variable">%opt</span> ) <span class="keyword">while</span> <span class="number">1</span>;</span><br><span class="line">        print_log(<span class="string">"max requests per child reached ("</span>.<span class="variable">$conf</span>&#123;<span class="string">'REQUESTS_PER_CHILD'</span>&#125;.<span class="string">")"</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="comment"># this exit is VERY important, otherwise the child will become</span></span><br><span class="line">        <span class="comment"># a producer of more and more children, forking yourself into</span></span><br><span class="line">        <span class="comment"># process death.</span></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>脚本中另一个修改的地方，在<code>parse_env</code>函数中，它解析client发送上来的数据<code>$job_data</code>时会做一个base64解码，但我client端的数据并没有做base编码（也没有加密），这里注释掉这个解码<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Parse %ENV and return a global hash %NAGIOS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="sub"><span class="keyword">sub</span> parse_env &#123;</span></span><br><span class="line">    <span class="keyword">my</span> <span class="variable">$job_data</span> = <span class="keyword">shift</span>;</span><br><span class="line">    <span class="variable">%NAGIOS</span> = ();</span><br><span class="line">    <span class="variable">$NAGIOS</span><span class="string">&#123;DATATYPE&#125;</span> = <span class="string">"SERVICEPERFDATA"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">defined</span> <span class="variable">$opt_gm</span>)&#123;</span><br><span class="line">        <span class="comment"># Gearman Worker</span></span><br><span class="line">        <span class="comment"># 由于我client端没做base64编码，这里就不需要解码了</span></span><br><span class="line">        <span class="comment">#$job_data = decode_base64($job_data);</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$conf</span><span class="string">&#123;ENCRYPTION&#125;</span> == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable">$job_data</span> = <span class="variable">$cypher</span>-&gt;decrypt( <span class="variable">$job_data</span> )        </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">my</span> <span class="variable">@LINE</span> = <span class="keyword">split</span>(<span class="regexp">/\t/</span>, <span class="variable">$job_data</span>);</span><br><span class="line">        <span class="keyword">foreach</span> <span class="keyword">my</span> <span class="variable">$k</span> (<span class="variable">@LINE</span>) &#123;</span><br><span class="line">            <span class="variable">$k</span> =~ <span class="regexp">/([A-Z 0-9_]+)::(.*)$/</span>;</span><br><span class="line">            <span class="variable">$NAGIOS</span>&#123;<span class="variable">$1</span>&#125; = <span class="variable">$2</span> <span class="keyword">if</span> (<span class="variable">$2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="variable">$NAGIOS</span><span class="string">&#123;HOSTNAME&#125;</span> ) &#123;</span><br><span class="line">            print_log( <span class="string">"Gearman job data missmatch. Please check your encryption key."</span>, <span class="number">0</span> );</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">%NAGIOS</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时修改这个perl脚本配置文件<code>/home/pnp4nagios/etc/process_perfdata.cfg</code>中关于gearman的配置项，主要是启动4个进程作为4个worker、server端的ip和端口号、以及不使用加密（默认是加密）:<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># File with RRA options used to create new RRD files</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">RRA_CFG = /home/pnp4nagios/etc/rra.cfg</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># Gearman Worker Config</span></span><br><span class="line"><span class="preprocessor"># Only used when running as Gearman worker</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># How many child processes</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">PREFORK = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Gearman server to connect to</span></span><br><span class="line"><span class="preprocessor"># Comma separated list of Gearman job servers</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">GEARMAN_HOST = localhost:<span class="number">4730</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="preprocessor"># Enables or disables encryption.</span></span><br><span class="line"><span class="preprocessor"># It is strongly advised to not disable encryption, or</span></span><br><span class="line"><span class="preprocessor"># anybody will be able to inject packages to your worker.</span></span><br><span class="line"><span class="preprocessor"># When using encryption, you will have to specify a shared</span></span><br><span class="line"><span class="preprocessor"># secret eithr via the KEY or the KEY_FILE option.</span></span><br><span class="line"><span class="preprocessor"># Default is 1.</span></span><br><span class="line"><span class="preprocessor">#</span></span><br><span class="line">ENCRYPTION = <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>基于上面的修改和配置，接着启动worker进程，传入2个参数<code>--gearman --daemon</code>给到<code>process_perfdata.pl</code>即可<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">cat</span> run.<span class="keyword">sh</span></span><br><span class="line">#!/bin/<span class="keyword">sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> process_perfdata | <span class="keyword">grep</span> -<span class="keyword">v</span> <span class="keyword">grep</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs kill -<span class="number">9</span></span><br><span class="line"><span class="keyword">sleep</span> <span class="number">1</span></span><br><span class="line">su - nagios -<span class="keyword">c</span> <span class="string">"perl /home/pnp4nagios/libexec/process_perfdata.pl --gearman --daemon"</span></span><br><span class="line"><span class="keyword">sleep</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> process_perfdata | <span class="keyword">grep</span> -<span class="keyword">v</span> <span class="keyword">grep</span></span><br></pre></td></tr></table></figure></p>
<p>完整的<code>process_perfdata.pl</code>在gist: <a href="https://gist.github.com/popozhu/9509554" target="_blank" rel="external">https://gist.github.com/popozhu/9509554</a></p>
<p><br></p>
<p>###client端<br>把合并后的数据以异步提交的方式发送到server端，由于<code>process_perfdata.pl</code>的worker向server端注册的函数名是<code>perfdata</code>，client向server端提交数据时，也得使用相同的函数名<code>perfdata</code><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"><span class="keyword">use</span> <span class="constant">Gearman:</span><span class="symbol">:Client</span>;</span><br><span class="line"></span><br><span class="line">my <span class="variable">$client</span> = <span class="constant">Gearman:</span><span class="symbol">:Client-&gt;new</span>;</span><br><span class="line"><span class="variable">$client</span>-&gt;job_servers(<span class="string">"localhost:4730"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他数据处理，最后是合并后的数据，在%perfdata里</span></span><br><span class="line"></span><br><span class="line">foreach my <span class="variable">$data</span> (keys %perfdata)&#123;</span><br><span class="line">	<span class="variable">$client</span>-&gt;dispatch_background(<span class="string">"perfdata"</span>, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以通过<code>/usr/bin/gearadmin --status</code>来查看当前执行的情况，输出的4个字段分别为:<br><code>注册的函数 任务队列中的任务数量 工作中的worker数量 总共有多少个worker</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/gearadmin --status</span><br><span class="line">perfdata        <span class="number">3061</span>    <span class="number">4</span>       <span class="number">5</span></span><br><span class="line">.</span><br></pre></td></tr></table></figure></p>
<p>最后3.4k条性能数据，以4个worker并发写入/更新到SSD硬盘的RRD文件里，大约40s，不到1分钟，收工。  </p>
<p><br><br>– EOF –</p>

	

	<div>
	    <div>Categories: <a class="category-link" href="/categories/in-lib/">in_lib</a> </div>
	    <div>Tags:<a class="tag-link" href="/tags/gearman/">gearman</a>,<a class="tag-link" href="/tags/pnp4nagios/">pnp4nagios</a> </div>
	</div>
    </div>

    <hr />
    <footer class="article-footer">
      
        <a href="http://popozhu.github.io/2014/03/12/pnp4nagios的并发/#disqus_thread" class="article-comment-link"></a>
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/03/22/code-style/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-caption">&laquo;</span>
      <span class="article-nav-title">
        
          code style
        
      </span>
    </a>
  
  
    <a href="/2014/03/09/pnp4nagios的模板/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">pnp4nagios的模板</span>
      <span class="article-nav-caption">&raquo;</span>
    </a>
  
</nav>


  
</article>


<section id="comments">
  <div id="disqus_thread"> </div>
</section>


</section>

	    <footer id="footer">
    popozhu &copy; 2016 
</footer>

	</div>

	
<!--
<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
-->


<script>
  var disqus_shortname = 'popozhu';
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


<script src="/js/script.js" type="text/javascript"></script>

    </body>
</html>
